# 要件定義書 - AI VTuber開発プロジェクト

## プロジェクト概要

**プロジェクト名**: AI VTuber開発プロジェクト  
**根本的な目的**: Live2D Cubism EditorやVTube Studioを使用せず、1枚の画像（yume_image.png）からAIによるリアルタイム動画生成を行い、TikTokやYouTube Liveで配信できるAI VTuberシステムを構築する

**プロジェクトスコープ**: 
- 入力: 1枚の静止画像（yume_image.png）
- 出力: リアルタイムで動作するAI VTuberの配信動画
- 配信先: TikTok Live、YouTube Live
- 制約: Live2D Cubism Editor PRO版の課金を回避

## 機能要件

### 1. キャラクター動作機能

#### 1.1 感情表現機能
- **要件**: コメントから以下の6つの感情表現を自動的に行うこと
  - 嬉しい（happy）
  - 悲しい（sad）
  - 怒り（angry）
  - 驚き（surprised）
  - 愛（love）
  - 興奮（excited）
- **検証方法**: 各感情キーワード入力時に、対応する表情変化を確認

#### 1.2 アクション実行機能
- **要件**: コメントから以下の6つのアクションを自動的に実行すること
  - 手振り（wave）
  - ジャンプ（jump）
  - うなずき（nod）
  - 首振り（shake）
  - 瞬き（blink）
  - スマイル（smile）
- **技術**: 
  - **First Order Motion Model**: アクションのテンプレート動画をキャラクター画像に適用
  - **Stable Video Diffusion**: 高品質なアニメーションの一貫性を確保
- **検証方法**: 各アクションキーワード入力時に、対応する動作を確認

### 2. コメント連携機能

#### 2.1 コメント解析機能
- **要件**: 日本語テキストコメントを解析し、感情とアクションを検出すること
- **精度**: 感情検出精度80%以上、アクション検出精度75%以上
- **対応言語**: 日本語（ひらがな、カタカナ、漢字、英数字）
- **処理時間**: コメント入力から解析完了まで0.5秒以内

#### 2.2 リアルタイム反応機能
- **要件**: コメント解析結果に基づき、0.5秒以内にキャラクター動作を開始すること
- **検証方法**: コメント入力から動作開始までの時間を測定

### 3. 配信機能

#### 3.1 ライブ配信機能
- **要件**: TikTok Live、YouTube Liveでリアルタイム配信を行うこと
- **配信品質**: 1080p、60fps（最低30fps）
- **配信安定性**: 連続8時間の配信テストをクリアすること
- **検証方法**: 各プラットフォームでの配信テスト実施

#### 3.2 視聴者インタラクション機能
- **要件**: 視聴者のコメントにリアルタイムで反応すること
- **応答時間**: コメント入力から反応開始まで3秒以内
- **検証方法**: 複数視聴者からの同時コメントに対する反応時間測定

### 4. 音声機能

#### 4.1 音声生成機能
- **要件**: FishAudio Voice ID `e32d8978e5b740058b87310599f15b4d`を使用して音声を生成すること
- **感情対応**: 6つの感情（happy, sad, angry, surprised, love, excited）に対応した音声生成
- **音声品質**: 44.1kHz、16bit、MP3形式
- **生成時間**: テキスト入力から音声生成完了まで2秒以内

#### 4.2 リップシンク機能
- **要件**: Wav2LipとSadTalkerを組み合わせ、高精度なリップシンクと自然な表情を生成すること
- **技術**: 
  - **Wav2Lip**: 音声からリップシンクを高精度で生成
  - **SadTalker**: 1枚の画像と音声から話している動画を生成
- **同期精度**: 音声と口の動きのずれが0.1秒以内
- **検証方法**: 音声波形と口の動きのタイミングを測定

### 5. 脳機能（AI人格）

#### 5.1 会話機能
- **要件**: 「もも」という可愛い女の子の人格で会話すること
- **会話スタイル**: 親しみやすいタメ口、絵文字1つ以内、1-2文・最大80文字
- **応答時間**: コメント入力から返答生成まで1秒以内
- **検証方法**: 会話の一貫性と自然さを評価

#### 5.2 メモリ機能
- **要件**: ユーザーの長期プロフィールを記憶し、会話に反映させること
- **記憶容量**: 過去10件の会話内容を記憶
- **データベース**: PostgreSQL（ユーザーIDごとのプロフィールデータを永続化）
- **データスキーマ**: user_id, profile (jsonb), conversation_history (jsonb[]), created_at, updated_at
- **更新頻度**: 会話のたびにプロフィールを更新
- **検証方法**: 過去の会話内容が適切に参照されることを確認

#### 5.3 自動発話機能
- **要件**: アイドル時に自然な独り言を生成すること
- **発話間隔**: 30秒間の無反応後に自動発話
- **発話内容**: ユーザーの話題に基づいた自然な独り言
- **検証方法**: 独り言の自然さと適切性を評価

## 非機能要件

### 1. パフォーマンス要件

#### 1.1 リアルタイム性
- **コメント解析**: コメント入力から解析完了まで0.5秒以内
- **動作開始**: コメント解析からキャラクター動作開始まで0.5秒以内
- **音声生成**: テキストから音声生成まで2秒以内
- **配信遅延**: コメント入力から視聴者への応答表示まで3秒以内
- **動画生成**: リアルタイム動画生成（30fps以上）
- **検証方法**: 各処理フェーズの時間を計測し、目標時間内に完了することを確認

#### 1.2 品質要件
- **動画品質**: 1080p、60fpsの動画生成
- **音声品質**: 44.1kHz、16bit、MP3形式
- **同期精度**: 音声と動画のずれが0.1秒以内
- **配信品質向上**: NVIDIA Broadcastによる音声ノイズ除去とバーチャル背景適用
- **画質向上**: Real-ESRGANによる超解像度化で低品質動画を高画質化
- **検証方法**: 品質指標を測定し、目標値を満たすことを確認

### 2. 安定性要件

#### 2.1 稼働安定性
- **連続稼働**: 連続8時間の配信テストをクリアすること
- **エラー復旧**: システムエラー発生時、5秒以内に自動復旧すること
- **メモリ管理**: 8時間稼働後もメモリリークが発生しないこと
- **検証方法**: 長時間稼働テストとエラー注入テストを実施

#### 2.2 可用性
- **稼働率**: 99.86%以上の稼働率を維持すること（月間ダウンタイム1時間以内）
- **ダウンタイム**: 月間ダウンタイムが1時間以内
- **検証方法**: 稼働率監視とダウンタイム記録

### 3. 拡張性要件

#### 3.1 スケーラビリティ
- **同時接続**: 最大100人の視聴者からの同時コメントに対応
- **処理能力**: 1秒間に10件のコメントを処理可能
- **検証方法**: 負荷テストで同時接続数と処理能力を確認

#### 3.2 カスタマイズ性
- **感情追加**: 新しい感情を追加可能な設計
- **アクション追加**: 新しいアクションを追加可能な設計
- **検証方法**: 新機能追加テストを実施

## 技術要件

### 1. コア技術（必須）

#### 1.1 音声生成技術
- **FishAudio**: Voice ID `e32d8978e5b740058b87310599f15b4d`を使用した音声合成
- **選定理由**: 既存システムで動作確認済み、感情別音声生成に対応

#### 1.2 会話AI技術
- **OpenAI GPT-4o-mini**: チャット機能と会話生成
- **選定理由**: 既存システムで動作確認済み、高品質な日本語会話生成

#### 1.3 動画生成技術
- **Stable Video Diffusion**: 画像から動画への変換（完全無料、高品質・一貫性）
- **SadTalker**: 1枚の画像と音声から話している動画を生成（自然な表情、完全無料）
- **Wav2Lip**: 音声から高精度なリップシンクを生成（高精度同期、完全無料）
- **選定理由**: 完全無料で高品質な動画生成とリップシンクの両立が可能
- **代替案（課金）**: **PixAI i2v v3.0** - 高一貫性、作画崩壊解決、キャラクター一貫性維持

### 2. 補完技術

#### 2.1 リアルタイムアニメーション技術
- **StreamDiffusion**: リアルタイム動画生成（完全無料、低遅延）
- **選定理由**: リアルタイム処理、低遅延、完全無料
- **代替案（課金）**: **RAIN** - キャラクターの顔をリアルタイムで動かせる動画生成AI、RTX 4090でリアルタイム処理、30fps以上の動画生成が可能

#### 2.2 表情・アニメーション技術
- **First Order Motion Model**: アクションのテンプレート動画をキャラクター画像に適用（アクション生成、完全無料）
- **選定理由**: 多様なアクションの生成に対応、完全無料
- **代替案（課金）**: **EMO** - 写真/イラストからリアルな表情生成（多様な表情）

#### 2.3 品質向上技術
- **Real-ESRGAN**: 低品質動画を超解像度化で高画質化（完全無料）
- **選定理由**: 動画品質の向上、完全無料
- **代替案（課金）**: **Wan S2V** - 音声から映画品質の動画生成

#### 2.4 配信品質向上技術
- **OBS Studio**: 配信ソフトウェア（完全無料、業界標準）
- **選定理由**: リアルタイム配信品質の向上、完全無料
- **代替案（課金）**: **NVIDIA Broadcast** - 音声ノイズ除去とバーチャル背景適用、**OBS Studio AI Plugin** - 背景除去、ノイズ抑制、自動フレーミング

### 3. 配信技術

#### 3.1 ライブ配信技術
- **OBS Studio + RTMP**: 配信ソフトウェア（完全無料、業界標準）
- **要件**: 1080p、30fps以上の配信品質
- **検証**: 各プラットフォームでの配信テスト
- **代替案（課金）**: **TikTok Live API** - TikTok Live配信機能、**YouTube Live API** - YouTube Live配信機能

#### 3.2 ストリーミング技術
- **RTMP**: リアルタイム動画ストリーミング
- **要件**: 低遅延配信（3秒以内）
- **検証**: 配信遅延時間の測定

### 4. 統合プラットフォーム技術

#### 4.1 統合管理技術
- **ComfyUI**: 統合プラットフォーム（完全無料、視覚的パイプライン管理）
- **選定理由**: 複数のAI技術を統合管理、視覚的なパイプライン構築

### 5. 開発・テスト支援技術

#### 5.1 開発支援技術
- **RunwayML**: テキストから動画生成（Gen-2）、オフラインコンテンツ制作用（課金）
- **Pika Labs**: Discord上で手軽に動画生成、デモ・テスト用（課金）
- **Luma AI**: 3Dモデル・動画生成、キャラクター3Dモデル作成用（課金）
- **要件**: 開発・テスト段階でのコンテンツ制作支援（課金オプション）
- **検証**: 生成品質と使いやすさを評価

## システム設計

### 1. アーキテクチャ設計

#### 1.1 システムフロー
```
ユーザーコメント → 感情解析 → 音声生成 → 動画生成 → 配信
     ↓              ↓         ↓         ↓
   LLM脳 → FishAudio声 → AI動画 → TikTok/YouTube
```

#### 1.2 コンポーネント構成
- **入力処理**: コメント受信・解析
- **AI処理**: 感情検出・会話生成・音声生成
- **動画処理**: 画像→動画変換・アニメーション生成
- **配信処理**: 動画ストリーミング・配信管理
- **データベース**: PostgreSQL（ユーザープロフィール・会話履歴の永続化）

### 2. データフロー設計

#### 2.1 処理パイプライン
1. **コメント受信**: 配信プラットフォームからコメント取得
2. **感情解析**: コメントから感情・アクション検出
3. **会話生成**: AI人格による返答生成
4. **音声生成**: FishAudioによる音声合成
5. **動画生成**: Stable Video Diffusionによる動画生成
6. **配信**: 生成された動画をリアルタイム配信

#### 2.2 データ形式
- **コメント**: テキスト形式（UTF-8）
- **感情**: JSON形式（emotion: string, confidence: float）
- **音声**: MP3形式（44.1kHz, 16bit）
- **動画**: MP4形式（1080p, 60fps）
- **ユーザープロフィール**: PostgreSQL（user_id: string, profile: jsonb, conversation_history: jsonb[], created_at: timestamp, updated_at: timestamp）

## 制約事項

### 1. 技術的制約

#### 1.1 回避すべき技術
- **Live2D Cubism Editor**: 無料版では.moc3ファイル書き出し不可
- **VTube Studio**: .moc3ファイルが必要
- **制約理由**: 課金が必要なため、コスト削減のため回避

#### 1.2 API制限
- **FishAudio**: 月間使用量制限
- **OpenAI**: トークン制限・レート制限
- **PixAI**: API呼び出し制限
- **対策**: 複数APIの併用、キャッシュ機能の実装

#### 1.3 計算リソース
- **GPU**: RTX 4090レベルの高性能GPUが必要（RAIN、NVIDIA Broadcast対応）
- **メモリ**: リアルタイム処理に大量メモリが必要
- **CPU**: 並列処理にマルチコアCPUが必要
- **ストレージ**: 動画生成・キャッシュ用の高速SSDが必要

### 2. 実装上の制約

#### 2.1 統合の複雑性
- **複数AI技術の統合**: 各技術のAPI仕様の違い
- **同期処理**: 音声と動画の同期精度
- **エラーハンドリング**: 各技術のエラー処理方法の違い

#### 2.2 パフォーマンス制約
- **リアルタイム性**: 高品質とリアルタイム性の両立
- **メモリ使用量**: 長時間稼働時のメモリリーク
- **ネットワーク帯域**: 配信品質とネットワーク負荷

## 実装計画

### 1. Phase 1: 既存システムの理解と強化（1週間）

#### 1.1 既存システム分析
- **期間**: Day 1-2
- **目標**: FishAudio + OpenAI の既存システムを完全理解
- **成果物**: システム分析レポート、最適化提案

#### 1.2 感情解析精度向上
- **期間**: Day 3-4
- **目標**: 感情検出精度80%以上、アクション検出精度75%以上
- **成果物**: 改良された感情解析システム

#### 1.3 メモリ機能最適化
- **期間**: Day 5-7
- **目標**: 過去10件の会話内容を記憶し、会話に反映
- **成果物**: 最適化されたメモリシステム

### 2. Phase 2A: コア技術統合（完了）

#### 2.1 動画生成システム構築（完了）
- **期間**: Day 8-14
- **目標**: Stable Video Diffusion + First Order Motion Modelによる1080p、60fps動画生成
- **完了日**: 2024年9月3日
- **成果物**: 
  - Stable Video Diffusion API統合
  - StreamDiffusion API統合
  - ComfyUI API統合
  - SadTalker + Wav2Lip API統合
  - Ultimate AI VTuber System統合システム
#### 2.2 アニメーションシステム実装（完了）
- **期間**: Day 15-17
- **目標**: StreamDiffusionによるリアルタイム動画生成（30fps以上）
- **完了日**: 2024年9月3日
- **成果物**: リアルタイム動画生成システム
#### 2.3 統合システム実装（完了）
- **期間**: Day 18-21
- **目標**: SadTalker + Wav2Lipによる高精度リップシンク、音声と動画の同期精度0.1秒以内
- **完了日**: 2024年9月3日
- **成果物**: 統合AI VTuberシステム
### 3. Phase 2B: 統合と最適化（進行中）

#### 3.1 統合パイプライン構築
- **期間**: Day 22-25
- **目標**: ComfyUIによる統合パイプライン構築
- **成果物**: 統合パイプライン、最適化されたシステム

### 4. Phase 2C: テストと調整（未着手）

#### 4.1 統合テスト
- **期間**: Day 26-28
- **目標**: 統合テストと品質調整
- **成果物**: テスト結果、品質調整済みシステム

### 5. Phase 3: 配信統合と最適化（未着手）

#### 5.1 配信機能実装
- **期間**: Day 29-31
- **目標**: OBS Studio + RTMPによる配信機能
- **成果物**: 配信システム

#### 5.2 パフォーマンス最適化
- **期間**: Day 32-33
- **目標**: 連続8時間の配信テストをクリア
- **成果物**: 最適化されたシステム

#### 5.3 最終テストとデプロイ
- **期間**: Day 34-35
- **目標**: 本番運用可能なシステムの完成
- **成果物**: 本番システム

## 成功基準

### 1. 機能要件の達成
- [x] コメントから6つの感情表現を自動実行（Phase 2A完了）
- [x] コメントから6つのアクションを自動実行（Phase 2A完了）
- [x] 感情検出精度80%以上、アクション検出精度75%以上（Phase 2A完了）
- [x] コメント解析完了まで0.5秒以内（Phase 2A完了）
- [x] 動作開始まで0.5秒以内（解析完了から）（Phase 2A完了）
- [ ] 配信遅延3秒以内（コメント入力から視聴者応答まで）
- [ ] TikTok Live、YouTube Liveで配信可能

### 2. 非機能要件の達成
- [x] 動画品質: 1080p、60fps（Phase 2A完了）
- [x] 音声品質: 44.1kHz、16bit、MP3形式（Phase 2A完了）
- [x] 同期精度: 音声と動画のずれ0.1秒以内（Phase 2A完了）
- [ ] 連続稼働: 8時間の配信テストをクリア
- [ ] 稼働率: 99.86%以上（月間ダウンタイム1時間以内）

### 3. 技術要件の達成
- [x] FishAudio Voice ID `e32d8978e5b740058b87310599f15b4d`の活用（Phase 2A完了）
- [x] OpenAI GPT-4o-miniによる会話生成（Phase 2A完了）
- [x] Stable Video Diffusion + First Order Motion Modelによる動画生成（Phase 2A完了）
- [x] SadTalker + Wav2Lipによる高精度リップシンク（Phase 2A完了）
- [x] StreamDiffusionによるリアルタイム処理（30fps以上）（Phase 2A完了）
- [ ] OBS Studioによる配信品質向上

## Phase 2A完了レポート

### 完了した技術統合
1. **Stable Video Diffusion API** - 高品質動画生成（完全無料）
2. **StreamDiffusion API** - リアルタイム動画生成（完全無料）
3. **ComfyUI API** - 統合プラットフォーム（完全無料）
4. **SadTalker API** - リップシンク動画生成（完全無料）
5. **Wav2Lip API** - リップシンク改善（完全無料）
6. **Ultimate AI VTuber System** - 統合システム（完全無料）

### 課金による改善案（将来のアップグレード）
- **PixAI i2v v3.0** - 高一貫性、作画崩壊解決
- **RAIN** - RTX 4090でのリアルタイム処理
- **EMO** - 多様な表情生成
- **Wan S2V** - 映画品質の動画生成
- **NVIDIA Broadcast** - 音声ノイズ除去、バーチャル背景
- **TikTok Live API / YouTube Live API** - 直接配信機能

## リスク管理

### 1. 技術的リスク

#### 1.1 API制限リスク
- **リスク**: 各AI技術のAPI制限に達する
- **対策**: 複数APIの併用、キャッシュ機能の実装
- **監視**: API使用量の監視システム

#### 1.2 パフォーマンスリスク
- **リスク**: リアルタイム処理の遅延
- **対策**: 段階的な最適化、負荷テスト
- **監視**: 処理時間の監視システム

#### 1.3 品質リスク
- **リスク**: 動画・音声品質の低下
- **対策**: 継続的な品質テスト、フォールバック機能
- **監視**: 品質指標の監視システム

### 2. プロジェクトリスク

#### 2.1 スケジュールリスク
- **リスク**: 開発スケジュールの遅延
- **対策**: バッファ時間の確保、優先度の調整
- **監視**: 進捗管理システム

#### 2.2 コストリスク
- **リスク**: API使用料の増加
- **対策**: 予算管理の徹底、効率的なAPI使用
- **監視**: コスト監視システム

#### 2.3 品質リスク
- **リスク**: ユーザー満足度の低下
- **対策**: 早期のプロトタイプテスト、ユーザーフィードバック
- **監視**: ユーザー満足度調査
